# 自动升级器
pg管理平台支持自动升级，解决人员手动升级特别是跨版本升级需手动操作的问题。

# 如何工作
先检查是否存在database，不存在则创建。

自动升级器支持**跨版本升级**和**全新部署** 2种方式。自动升级器可以自动执行sql脚本。
## 1. 新建文件
在版本配置目录auto-update中新建一个名字和当前版本号名称相同的目录

可新建3个和sql相关的文件，每个文件说明如下：
> * full.sql: 全新部署时执行的sql全量脚本
> * inc.sql： 版本升级所需执行的sql增量脚本
> * inc-rollback.sql： 版本升级失败时进行回滚的脚本，是inc.sql的逆操作文件

## 2. 获取新版本号
新版本号在 application.yml 文件的 version 属性中指定。

## 3. 获取旧版本号
可在 application.yml 文件中添加属性 versionNo.admin.old 指定旧版本号；V2.4.2之后会在数据库中新建一个表 pg_version_info，记录版本升级链和查询旧版本号，该表的版本号优先级高于 oldVersion 属性。

## 4.判断升级模式
如果旧版本号为空，则表示是**全新部署**，将会执行 full.sql 文件；如果旧版本不为空且低于新版本，则会执行**批量升级器**，会执行 inc.sql文件。

## 5. 执行
升级或全新部署成功后，会将新版本号写入 pg_version_info 表。

# 开发
## 1. 编写升级器
每个版本的升级器不是必须的。如须在指定版本执行某些升级操作，才须新建一个升级器类，该类需继承自 AbstractBaseUpdater 抽象类或实现接口 IUpdater，实现 update 方法和 rollback 方法。

## 2. 升级
升级操作会执行升级器的 update 方法。inc.sql文件不会被自动执行，如需执行这些文件，需在 update 方法中实现。在 AbstractBaseUpdater 中已经实现了执行这些文件的逻辑，建议调用该类的 update 方法执行。

## 3. 回滚
如果升级失败，会进行回滚操作，逆序执行升级器的 rollback 方法。回滚内容有主要是增量sql。inc-rollback.sql文件不会自动执行，如需执行这个文件，需在 rollback 方法中实现。在 AbstractBaseUpdater 中的 rollback 方法已经实现了回滚sql的逻辑，建议调用该类的 rollback 方法执行。

> inc-rollback.sql 脚本的sql语句需具备幂等性，否则有可能导致回滚失败，或者数据不正确。

> 如果是全新部署，升级器不会被执行。

# 其它

## 1.版本号格式
版本号支持 [版本号]_P[补丁号]-[版本性质]的模式，举例如下：
> * 2.7.5               // 合法，只有版本号
> * 2.7.5_P1            // 合法，版本号和补丁号
> * 2.7.5-SNAPSHOT      //合法，版本号和SNAPSHOT版本
> * 2.7.5_P1-SNAPSHOT   //合法，版本号、补丁号和SNAPSHOT版本
> * 2.7.5.SNAPSHOT      //非法，版本号不为数字

> 其中版本性质在版本号高低的比较中不起作用，如 2.7.5 和  2.7.5-SNAPSHOT 版本号相同

## 2. 执行失败
如果版本升级或全新部署失败，整个管理平台启动失败，需查看日志解决问题后再启动。

##3. 备份
建议启动管理平台前进行数据库备份。